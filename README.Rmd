---
title: "STOCfree: prediction of probabilities of freedom from infection from longitudinal data"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The aim of the STOCfree package is to predict herd level probabilities of freedom from infection from longitudinal data collected as part of surveillance programmes.

Below, the use of the package is presented through the analysis of a small dataset collected for the surveillance of infection by the BVDV virus in cattle.

# Package installation and update

Before installing the package, you need to make sure that JAGS is installed. This programme can be installed from the following website: https://sourceforge.net/projects/mcmc-jags/files/.

The easiest way to install the `STOCfree` package is from Github. This requires installing the `devtool` package first.

```{r, eval = FALSE, message=FALSE}
install.packages("devtools")
```

Then load the `devtool` package:

```{r, eval = FALSE}
library(devtools)
```

In order to install (or update) the STOCfree package, run the following line:

```{r, eval = FALSE}
install_github("AurMad/STOCfree")
```

# Attaching packages

The `STOCfree` package needs to be attached.

```{r}
library(STOCfree)
```

The list of available functions and datasets can be accessed by typing

```{r, eval = FALSE}
help(package="STOCfree")
```

We also attach the following packages that will be used later:

```{r}
library(ggplot2)
```


# Data

The `STOCfree` package contains a dataset called `herdBTM` which contains the results of antibody ELISA tests performed on bulk tank milk. Each row is a testing date in a herd. There are 100 herds with 11 tests for each herd.

```{r}
head(herdBTM)
```

# Formatting the data for analysis

Herds in the `herdBTM` are tested approximately every 6 months. The STOCfree model models infection with a montlhy time step. The data used by the model need to have one row per month. The herdBTM data is expanded to have one row per month with the `expand_month()` function.

```{r, message=FALSE}
herdBTM_month <- expand_month(data = herdBTM,
                              herd_colname = Farm,
                              date_colname = DateOfTest,
                              test_res_colname = TestResult)

herdBTM_month
```

# Priors

## Test

Prior for tests are stored in a variable called `test_priors`.

```{r}
test_priors <- list(
  Se_beta_a = 12,
  Se_beta_b = 2,
  Sp_beta_a = 200,
  Sp_beta_b = 4
)

```

## Infection dynamics

Probability of being infected on the first testing time for a herd and probability of not eliminating the infection between 2 consecutive tests.

```{r}
infection_priors <- list(
  pi1_beta_a = 1,
  pi1_beta_b = 2,
  tau2_beta_a = 30,
  tau2_beta_b = 2
 )
```

The probability of new infection is modelled as a function of risk factors using logistic regression. In this example, we use 2 risk factors. We need priors for both the model intercept and the coefficients associated with the presence of the risk factors. These priors are defined with normal distributions on the logit scale. For each coefficient, we need the mean (`theta_norm_mean` in the code below) and standard deviation (`theta_norm_sd` in the code below) of these dsitributions.

```{r}
risk_factor_priors <- list(
  theta_norm_mean = c(-2, 0, 0),
  theta_norm_sd = c(1, 2, 2)
)
```

The `plot_priors_rf()` is used to plot the probability distributions associated with these priors.

```{r}
plot_priors_rf(risk_factor_priors)
```


# STOC free model

## Compiling

The JAGS model is compiled using the `compile_JAGS` function. We just use 3 herds to test the code. We declare two risk factors of new infection: `ln_nOrig6_12` and `LocalSeroPrev`. This will result in 3 coefficients associated with the log-odds probability of new infection: intercept, coefficient for `ln_nOrig6_12` and coefficient for `LocalSeroPrev`.

```{r, message = FALSE}
test <- expand_month(data = herdBTM[herdBTM$Farm %in% c("FR001", "FR002", "FR003"),],
                     herd_colname = Farm,
                     date_colname = DateOfTest,
                     test_res_colname = TestResult)

compiled_model <- compile_JAGS(test_data = test, 
             herd_id = herd_id, 
             row_id = row_id,
             month = month_id,
             risk_factors = c("ln_nOrig6_12", "LocalSeroPrev"),
             test_result = TestResult,
             test_priors = test_priors, 
             infection_priors = infection_priors, 
             risk_factor_priors = risk_factor_priors,
             n_chains = 4)
```

## Samples from the parameter posterior distributions

Samples from the posterior distributions of model parameters, predicted probabilities of infection and predicted statuses are drawn using the `sample_model` function. 

```{r, message=FALSE}
samples <- sample_model(compiled_model, n_burnin = 100, n_iter = 100, n_thin = 5)
```

# Results

The model retruns a list with 2 components:

- samples from the model parameters posterior distributions
- samples from the predicted probability of infection posterior distributions

## Model parameters

The samples from the model parameter posterior distributions are in the `parameters` component of the variable in which we have stored the model results. We put them in a new variable called `param` to explore these distributions.

```{r}
param <- samples$parameters

param
```


The columns of this dataset are:

 - `.chain`: chain number. Between 1 and 4 in the example because we ran 4 MCMC chains in JAGS. This number is the value we selected for `n_chains` in the call to `compile_JAGS`.
 - `.iteration`: iteration number. Defined by the n_iter value in the call to sample_model
 - `.draw`: number of iterations from the first iteration in chain 1, pooling all the chains
 - `Se`: sample for sensitivity for this draw
 - `Sp`:  sample for pecificity for this draw
 - `tau2`:  sample for tau2 for this draw
 - `theta.1`: sample for the logistic model intercept for this draw
 - `theta.2`: sample for the coefficient associated with the first risk factor for this draw
 - `theta.3`: sample for  the coefficient associated with the second risk factor for this draw

```{r, echo = FALSE}
par(mfrow = c(2, 3),
    mar = c(3, 4, 3, 1))
plot(density(param$Se),
     xlim = c(0, 1), xlab = "",
     main = "Sensitivity")
plot(density(param$Sp),
     xlim = c(0, 1), xlab = "",
     main = "Specificity")
plot(density(param$tau2),
     xlim = c(0, 1), xlab = "",
     main = "tau2")

plot(density(param$theta.1),
     xlab = "",
     main = "Model intercept")

plot(density(param$theta.2),
     xlab = "",
     main = "theta.2")

plot(density(param$theta.3),
     xlab = "",
     main = "theta.3")
```

## Probability of infection

The samples from posterior distributions of the predicted probabilities of infection  are in the `proba_inf` component of the variable in which we have stored the model results. We put them in a new variable called `proba_inf` to explore these distributions.

```{r}
proba_inf <- samples$proba_inf

proba_inf
```

The first columns of this dataset are the same as above. The following columns differ:

- `herd_id`: herd identifier
- `predicted_proba`: predicted probability of infection on this draw
- `predicted_status`: predicted status regarding infection on this draw. This status was simulated by using `predicted_proba` for this draw as the proportion parameter in a Bernoulli distribution.

Below we represent the densities for the predicted probabilities of infection for both the draws predicted as infected and the draws predicted as uninfected. From this, a rule to categorise herds as free from infection or not needs to be created.

```{r}
cols <- hcl(h = c(120, 0), c = 100, l = 85)

ggplot(proba_inf, aes(x = predicted_proba, colour = factor(predicted_status))) +
  geom_density() +
  xlim(0, 1) +
  xlab("Predicted probability of infection") +
  scale_color_manual(labels = c("Uninfected", "Infected"), values = cols) +
  guides(colour = guide_legend(title="Predicted status"))
```

Below are the probability densities for each of the herds modelled. Each color represents a herd. 

```{r}
ggplot(proba_inf, aes(x = predicted_proba, colour = factor(herd_id))) +
  geom_density() +
  xlim(0, 1) +
  xlab("Predicted probability of infection") +
  theme(legend.position="none")
```

The steps envisonned to categorise herds as free from infection are:

- define a summary for each density, e.g. 5th percentile of the predicted probability of infection
- choose a cut-off to define freedom from infection, e.g. categorise herds with the 5th percentile below 0.1 as free from infection

